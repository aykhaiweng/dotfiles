#!/bin/bash
MAP_FILE="$DOTFILES/.gist_map"
FOLDER="$DOTFILES/private"
DRY_RUN=false

# Ensure map file exists
touch "$MAP_FILE"

# Check for dry-run flag
if [[ "$1" == "--dry-run" || "$1" == "-d" ]]; then
    DRY_RUN=true
    echo "--- DRY RUN MODE ENABLED ---"
fi

touch "$MAP_FILE"

# Helper for cross-platform MD5
get_md5() {
    if command -v md5sum >/dev/null; then md5sum "$1" | awk '{print $1}'; else md5 -q "$1"; fi
}

for file in "$FOLDER"/*; do
    [ -f "$file" ] || continue
    filename=$(basename "$file")
    gist_id=$(grep "^$filename:" "$MAP_FILE" | cut -d':' -f2 | tr -d '[:space:]')
    
    if [ -z "$gist_id" ]; then
        if [ "$DRY_RUN" = true ]; then
            echo "[DRY-RUN] Would CREATE $filename"
        else
            echo "Creating $filename..."
            output=$(gh gist create "$file" --public=false)
            new_id=$(echo "$output" | grep -oE '[a-f0-9]{32}' | head -n 1 | tr -d '[:space:]')
            echo "$filename:$new_id" >> "$MAP_FILE"
        fi
    else
        # Fetch remote content and metadata
        remote_content=$(gh gist view "$gist_id" -r -f "$filename")
        remote_md5=$(echo "$remote_content" | awk 'NF' | get_md5 -) # Strip trailing newlines for comparison
        local_md5=$(get_md5 "$file")

        if [ "$local_md5" = "$remote_md5" ]; then
            echo "$filename: No content changes detected. Skipping."
            continue
        fi

        # If different, fall back to timestamp logic
        remote_mod_raw=$(gh api "gists/$gist_id" --template '{{.updated_at}}')
        remote_mod=$(date -d "$remote_mod_raw" +%s)
        local_mod=$(stat -c %Y "$file")

        if [ "$local_mod" -gt "$remote_mod" ]; then
            if [ "$DRY_RUN" = true ]; then
                echo "[DRY-RUN] Would PUSH $filename (Content differs)"
            else
                echo "Pushing changes to $filename..."
                gh gist edit "$gist_id" -a "$file"
            fi
        else
            if [ "$DRY_RUN" = true ]; then
                echo "[DRY-RUN] Would PULL $filename (Content differs)"
            else
                echo "Pulling changes for $filename..."
                echo "$remote_content" > "$file"
            fi
        fi
    fi
done
